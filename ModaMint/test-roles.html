<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test RBAC - Role Decoding</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            background: #f9f9f9;
            border-left: 4px solid #4CAF50;
        }
        .token-input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }
        button {
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #45a049;
        }
        .result {
            margin: 15px 0;
            padding: 15px;
            background: #e8f5e9;
            border-radius: 4px;
            font-family: monospace;
        }
        .error {
            background: #ffebee;
            color: #c62828;
        }
        .success {
            background: #e8f5e9;
            color: #2e7d32;
        }
        .info {
            background: #e3f2fd;
            color: #1565c0;
        }
        pre {
            background: #263238;
            color: #aed581;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
        }
        .role-badge {
            display: inline-block;
            padding: 5px 10px;
            margin: 5px;
            border-radius: 4px;
            font-weight: bold;
        }
        .role-admin {
            background: #f44336;
            color: white;
        }
        .role-user {
            background: #2196F3;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê RBAC Test - JWT Role Decoder</h1>
        
        <div class="section">
            <h2>1. Test v·ªõi JWT Token c·ªßa b·∫°n</h2>
            <p>Paste JWT token v√†o √¥ d∆∞·ªõi v√† click "Decode":</p>
            <textarea 
                id="tokenInput" 
                class="token-input" 
                rows="3" 
                placeholder="Paste JWT token here..."
            ></textarea>
            <button onclick="decodeToken()">üîç Decode Token</button>
            <button onclick="clearToken()">üóëÔ∏è Clear</button>
            <div id="tokenResult"></div>
        </div>

        <div class="section">
            <h2>2. Test v·ªõi Sample Tokens</h2>
            <button onclick="testAdminToken()">Test ADMIN Token</button>
            <button onclick="testUserToken()">Test USER Token</button>
            <div id="sampleResult"></div>
        </div>

        <div class="section">
            <h2>3. Test localStorage authData</h2>
            <p>Ki·ªÉm tra authData trong localStorage c·ªßa b·∫°n:</p>
            <button onclick="checkLocalStorage()">üì¶ Check localStorage</button>
            <button onclick="simulateLogin('ADMIN')">Simulate ADMIN Login</button>
            <button onclick="simulateLogin('USER')">Simulate USER Login</button>
            <button onclick="clearLocalStorage()">üóëÔ∏è Clear localStorage</button>
            <div id="localStorageResult"></div>
        </div>

        <div class="section">
            <h2>4. Test getCurrentRoles() Function</h2>
            <button onclick="testGetCurrentRoles()">üéØ Test getCurrentRoles()</button>
            <div id="getCurrentRolesResult"></div>
        </div>
    </div>

    <script>
        // Simulate getRolesFromToken function
        function getRolesFromToken(token) {
            try {
                const parts = token.split('.');
                if (parts.length !== 3) {
                    throw new Error('Invalid JWT format');
                }

                const payload = parts[1];
                const paddedPayload = payload.padEnd(payload.length + (4 - payload.length % 4) % 4, '=');
                const decodedPayload = atob(paddedPayload);
                const parsedPayload = JSON.parse(decodedPayload);

                let roles = [];

                // Case 1: Roles trong scope (string)
                if (parsedPayload.scope && typeof parsedPayload.scope === 'string') {
                    roles = parsedPayload.scope.split(' ').filter(role => role.trim() !== '');
                }
                // Case 2: Roles trong roles array
                else if (parsedPayload.roles && Array.isArray(parsedPayload.roles)) {
                    roles = parsedPayload.roles;
                }
                // Case 3: Roles trong authorities array
                else if (parsedPayload.authorities && Array.isArray(parsedPayload.authorities)) {
                    roles = parsedPayload.authorities;
                }

                return roles.filter(role => typeof role === 'string' && role.trim() !== '');
            } catch (error) {
                console.error('Error decoding token:', error);
                return [];
            }
        }

        // Decode token from input
        function decodeToken() {
            const token = document.getElementById('tokenInput').value.trim();
            const resultDiv = document.getElementById('tokenResult');

            if (!token) {
                resultDiv.innerHTML = '<div class="result error">‚ö†Ô∏è Vui l√≤ng nh·∫≠p token!</div>';
                return;
            }

            try {
                const parts = token.split('.');
                if (parts.length !== 3) {
                    throw new Error('Invalid JWT format - must have 3 parts');
                }

                // Decode payload
                const payload = parts[1];
                const paddedPayload = payload.padEnd(payload.length + (4 - payload.length % 4) % 4, '=');
                const decodedPayload = atob(paddedPayload);
                const parsedPayload = JSON.parse(decodedPayload);

                // Get roles
                const roles = getRolesFromToken(token);

                // Display results
                let rolesHTML = roles.map(role => {
                    const roleClass = role === 'ADMIN' ? 'role-admin' : 'role-user';
                    return `<span class="role-badge ${roleClass}">${role}</span>`;
                }).join('');

                resultDiv.innerHTML = `
                    <div class="result success">
                        <h3>‚úÖ Decode th√†nh c√¥ng!</h3>
                        <p><strong>Roles:</strong> ${rolesHTML || '<span style="color: orange;">Kh√¥ng t√¨m th·∫•y roles</span>'}</p>
                        <p><strong>Token Payload:</strong></p>
                        <pre>${JSON.stringify(parsedPayload, null, 2)}</pre>
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="result error">
                        <h3>‚ùå Decode th·∫•t b·∫°i!</h3>
                        <p><strong>Error:</strong> ${error.message}</p>
                    </div>
                `;
            }
        }

        function clearToken() {
            document.getElementById('tokenInput').value = '';
            document.getElementById('tokenResult').innerHTML = '';
        }

        // Create sample tokens
        function createSampleToken(role) {
            const header = btoa(JSON.stringify({ alg: 'HS256', typ: 'JWT' }));
            const payload = btoa(JSON.stringify({
                sub: 'user-id-123',
                scope: role,  // ADMIN ho·∫∑c USER
                username: role === 'ADMIN' ? 'admin' : 'user',
                iat: Math.floor(Date.now() / 1000),
                exp: Math.floor(Date.now() / 1000) + 3600
            }));
            const signature = 'fake-signature';
            return `${header}.${payload}.${signature}`;
        }

        function testAdminToken() {
            const token = createSampleToken('ADMIN');
            document.getElementById('tokenInput').value = token;
            decodeToken();
        }

        function testUserToken() {
            const token = createSampleToken('USER');
            document.getElementById('tokenInput').value = token;
            decodeToken();
        }

        function checkLocalStorage() {
            const resultDiv = document.getElementById('localStorageResult');
            const authDataStr = localStorage.getItem('authData');

            if (!authDataStr) {
                resultDiv.innerHTML = '<div class="result info">‚ÑπÔ∏è Kh√¥ng t√¨m th·∫•y authData trong localStorage</div>';
                return;
            }

            try {
                const authData = JSON.parse(authDataStr);
                
                // Check if roles field exists (should NOT exist)
                const hasRolesField = 'roles' in authData;
                
                // Get roles from token
                const rolesFromToken = authData.accessToken ? getRolesFromToken(authData.accessToken) : [];

                let rolesHTML = rolesFromToken.map(role => {
                    const roleClass = role === 'ADMIN' ? 'role-admin' : 'role-user';
                    return `<span class="role-badge ${roleClass}">${role}</span>`;
                }).join('');

                resultDiv.innerHTML = `
                    <div class="result ${hasRolesField ? 'error' : 'success'}">
                        <h3>${hasRolesField ? '‚ö†Ô∏è Warning!' : '‚úÖ Correct!'}</h3>
                        ${hasRolesField ? '<p>‚ö†Ô∏è authData ch·ª©a field "roles" - N√äN X√ìA!</p>' : '<p>‚úÖ authData KH√îNG ch·ª©a field "roles" - ƒê√∫ng!</p>'}
                        <p><strong>Roles t·ª´ token:</strong> ${rolesHTML || '<span style="color: orange;">Kh√¥ng t√¨m th·∫•y</span>'}</p>
                        <p><strong>authData structure:</strong></p>
                        <pre>${JSON.stringify(authData, null, 2)}</pre>
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<div class="result error">‚ùå Error: ${error.message}</div>`;
            }
        }

        function simulateLogin(role) {
            const token = createSampleToken(role);
            const authData = {
                accessToken: token,
                refreshToken: 'fake-refresh-token',
                user: {
                    id: 'user-123',
                    username: role === 'ADMIN' ? 'admin' : 'user',
                    email: `${role.toLowerCase()}@example.com`
                }
                // ‚úÖ KH√îNG c√≥ field roles
            };

            localStorage.setItem('authData', JSON.stringify(authData));
            
            document.getElementById('localStorageResult').innerHTML = `
                <div class="result success">
                    ‚úÖ Simulated ${role} login!<br>
                    Click "Check localStorage" to verify.
                </div>
            `;
        }

        function clearLocalStorage() {
            localStorage.removeItem('authData');
            document.getElementById('localStorageResult').innerHTML = '<div class="result info">üóëÔ∏è localStorage cleared!</div>';
        }

        function testGetCurrentRoles() {
            const authDataStr = localStorage.getItem('authData');
            const resultDiv = document.getElementById('getCurrentRolesResult');

            if (!authDataStr) {
                resultDiv.innerHTML = '<div class="result error">‚ùå Kh√¥ng t√¨m th·∫•y authData. Vui l√≤ng simulate login tr∆∞·ªõc!</div>';
                return;
            }

            try {
                const authData = JSON.parse(authDataStr);
                const roles = authData.accessToken ? getRolesFromToken(authData.accessToken) : [];

                let rolesHTML = roles.map(role => {
                    const roleClass = role === 'ADMIN' ? 'role-admin' : 'role-user';
                    return `<span class="role-badge ${roleClass}">${role}</span>`;
                }).join('');

                resultDiv.innerHTML = `
                    <div class="result success">
                        <h3>‚úÖ getCurrentRoles() Result:</h3>
                        <p><strong>Roles:</strong> ${rolesHTML || '<span style="color: orange;">[]</span>'}</p>
                        <p><strong>Method:</strong> Decoded from accessToken</p>
                        <pre>getCurrentRoles() => ${JSON.stringify(roles)}</pre>
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<div class="result error">‚ùå Error: ${error.message}</div>`;
            }
        }

        // Auto check on load
        window.onload = function() {
            const authDataStr = localStorage.getItem('authData');
            if (authDataStr) {
                document.getElementById('localStorageResult').innerHTML = '<div class="result info">‚ÑπÔ∏è ƒê√£ ph√°t hi·ªán authData. Click "Check localStorage" ƒë·ªÉ xem chi ti·∫øt.</div>';
            }
        };
    </script>
</body>
</html>

